# 名片OCR管理系統 應用流程文檔 v3.0

## 流程概覽

本系統提供完整的名片數位化管理流程，從智能掃描到資料管理的全生命週期支援。系統採用前後端分離架構，前端React運行於端口1002，後端FastAPI運行於端口8006。

---

## 核心流程圖

### 主要業務流程
```mermaid
flowchart TD
    A[啟動應用] --> B[首頁]
    B --> C{選擇操作}
    C -->|開始掃描/上傳| D[掃描上傳頁面]
    C -->|名片管理| R[名片管理頁面]
    
    D --> E{選擇模式}
    E -->|相機掃描| F[檢查相機權限]
    E -->|圖片上傳| G[選擇本地圖片]
    
    F -->|已授權| H[相機介面]
    F -->|未授權| I[請求權限]
    I --> H
    
    H --> J[掃描名片]
    G --> K[圖像預處理]
    J --> K
    
    K --> L[智能圖像增強]
    L --> M[OCR文字識別]
    M --> N[智能欄位解析]
    N --> O[資料確認與編輯頁面]
    
    O --> P[手動編輯與驗證]
    P --> Q[保存名片資料]
    Q --> R
    
    R --> S{選擇操作}
    S -->|查看詳情| T[名片詳情頁面]
    S -->|搜索名片| U[搜索結果]
    S -->|統計分析| V[統計儀表板]
    S -->|批量操作| W[批量處理頁面]
    S -->|匯出資料| X[匯出下載]
    
    W --> Y{批量類型}
    Y -->|圖片批量匯入| Z[圖片批量處理]
    Y -->|文本批量匯入| AA[Excel/CSV匯入]
    
    Z --> BB[OCR批量識別]
    BB --> CC[批量資料保存]
    CC --> R
    
    AA --> DD[欄位自動映射]
    DD --> EE[資料驗證與去重]
    EE --> FF[批量資料庫寫入]
    FF --> R
```

### 技術架構流程
```mermaid
sequenceDiagram
    participant U as 用戶
    participant F as 前端(React)
    participant B as 後端(FastAPI)
    participant OCR as OCR服務
    participant DB as 資料庫
    participant CV as 圖像處理
    
    U->>F: 啟動應用
    F->>B: 獲取系統狀態
    B->>F: 返回系統資訊
    F->>U: 顯示首頁
    
    U->>F: 選擇掃描/上傳
    F->>F: 檢查設備相機支援
    F->>U: 顯示掃描介面
    
    U->>F: 拍攝/上傳圖片
    F->>B: 上傳圖片檔案 (POST /api/v1/ocr/image)
    B->>CV: OpenCV圖像增強 (3x放大、去噪)
    CV->>B: 返回增強圖像
    B->>OCR: 發送至OpenAI Vision API
    OCR->>B: 返回結構化JSON資料
    B->>B: 驗證並映射25個標準欄位
    B->>F: 返回解析完成的JSON資料
    F->>U: 顯示編輯介面
    
    U->>F: 確認並保存
    F->>B: 提交名片資料
    B->>DB: 寫入資料庫
    DB->>B: 確認保存成功
    B->>F: 返回保存結果
    F->>U: 顯示成功訊息
```

---

## 詳細流程說明

### 1. 應用啟動與首頁

#### 1.1 系統初始化
**流程步驟**：
1. 用戶開啟瀏覽器訪問應用
2. 前端 React 應用載入
3. 檢查後端服務可用性
4. 載入用戶設定與快取資料
5. 顯示首頁主選單

**技術細節**：
- React Router 路由管理
- Axios API 客戶端初始化
- 響應式佈局適配移動/桌面端
- 服務可用性健康檢查

#### 1.2 主選單導航
**可用選項**：
- **開始掃描/上傳**: 進入名片輸入流程
- **名片管理**: 進入資料管理頁面

**用戶體驗**：
- 清晰的視覺引導
- 大按鈕設計適合觸控操作
- 簡潔的介面說明

### 2. 名片掃描與上傳流程

#### 2.1 掃描模式選擇
**流程分支**：

**相機掃描模式**：
1. 檢查瀏覽器相機API支援
2. 請求用戶相機權限
3. 初始化相機預覽
4. 顯示名片對齊框
5. 用戶拍攝名片
6. 即時圖像品質檢查

**圖片上傳模式**：
1. 顯示上傳區域
2. 支援拖拽或點擊選擇
3. 檔案格式驗證 (JPG/PNG)
4. 檔案大小檢查 (<10MB)
5. 圖像預覽確認

**技術實現**：
```javascript
// 相機管理系統 (cameraManager.js)
class CameraManager {
  async initializeCamera() {
    // 設備檢測與相機初始化
    // 支援前後攝像頭切換
    // 自動對焦與閃光燈控制
  }
}

// 上傳處理 (ScanUploadPage.js)
const handleFileUpload = async (file) => {
  // 檔案驗證 (JPG/PNG, <10MB)
  // 使用FormData上傳至 /api/v1/ocr/image
  // 上傳進度追蹤與錯誤處理
}
```

#### 2.2 圖像處理與增強
**處理流程**：
1. **基礎驗證**: 檔案格式、大小、圖像完整性
2. **智能增強**: 
   - OpenCV 邊界檢測與自動裁剪
   - 3倍解析度放大
   - 對比度與清晰度優化
   - 去噪與角度校正
3. **品質評估**: 確保OCR識別率
4. **暫存管理**: 自動清理臨時檔案

**技術棧**：
- **OpenCV**: 名片邊界檢測
- **PIL**: 基礎圖像處理
- **智能增強服務**: 自適應增強算法

### 3. OCR識別與欄位解析

#### 3.1 OCR文字識別
**識別流程**：
1. 圖像預處理完成後送入OCR引擎
2. OpenAI Vision API使用結構化提示詞
3. 直接返回JSON格式的25個標準欄位
4. 無需額外的文字解析步驟

**容錯機制**：
- 最多3次重試機制
- 超時處理 (30秒)
- 網路異常處理
- 支援本地OCR API備用方案
- 圖像增強失敗時使用原圖重試

#### 3.2 智能欄位解析
**解析引擎**：
```python
# 智能欄位解析 (ocr_service.py)
def parse_ocr_to_fields(ocr_text: str, side: str) -> Dict[str, str]:
    # 檢查是否已是JSON格式 (來自OpenAI API)
    # 若是JSON則直接驗證並返回
    # 若否則使用LLM進行二次解析
    # 確保返回25個標準化欄位
```

**支援欄位結構**：
- **基本資訊**: 姓名、公司名稱、職位 (中英文)
- **組織架構**: 三級部門結構 (中英文)
- **聯絡資訊**: 手機、電話、Email、Line ID
- **地址資訊**: 公司地址 (中英文)
- **備註資訊**: 自由文本欄位

### 4. 資料確認與編輯

#### 4.1 編輯介面設計
**介面元件**：
- 原始圖像預覽
- OCR原文對照
- 結構化欄位編輯表單
- 即時資料驗證
- 儲存草稿功能

**編輯特性**：
- 支援空欄位清除
- 中英文欄位對照
- 必填欄位提示
- 格式驗證 (電話、Email等)

#### 4.2 資料品質檢查
**健康度評估**：
```javascript
// 名片健康度檢查邏輯 (CardManagerPage.js)
const checkCardStatus = (card) => {
  const missingFields = [];

  // 檢查姓名 (中文OR英文)
  if (!card.name_zh?.trim() && !card.name_en?.trim()) {
    missingFields.push('姓名');
  }

  // 檢查公司 (中文OR英文)
  if (!card.company_name_zh?.trim() && !card.company_name_en?.trim()) {
    missingFields.push('公司');
  }

  // 檢查職位或部門 (至少一個)
  const hasPosition = Boolean(card.position_zh?.trim() || card.position_en?.trim() ||
                             card.position1_zh?.trim() || card.position1_en?.trim());
  const hasDepartment = Boolean(card.department1_zh?.trim() || card.department1_en?.trim() ||
                                card.department2_zh?.trim() || card.department2_en?.trim() ||
                                card.department3_zh?.trim() || card.department3_en?.trim());
  if (!hasPosition && !hasDepartment) {
    missingFields.push('職位或部門');
  }

  // 檢查聯絡方式 (至少一個)
  if (!card.mobile_phone?.trim() && !card.company_phone1?.trim() &&
      !card.company_phone2?.trim() && !card.email?.trim() && !card.line_id?.trim()) {
    missingFields.push('聯絡方式');
  }

  return {
    status: missingFields.length === 0 ? 'normal' : 'problem',
    missingFields: missingFields
  };
}
```

### 5. 名片資料管理

#### 5.1 資料展示與搜尋
**管理介面功能**：
- **列表檢視**: 卡片式展示，支援分頁載入
- **詳情檢視**: 完整名片資訊展示
- **搜尋功能**: 多欄位模糊搜尋
- **篩選功能**: 依狀態、公司、職位篩選
- **排序功能**: 多種排序方式

**搜尋實現**：
```python
# 後端搜尋API (card.py)
@router.get("/")
def list_cards(
    search: Optional[str] = None,
    skip: int = 0,
    limit: int = 100,
    use_pagination: bool = False
):
    # 支援多欄位模糊搜尋 (姓名、公司、職位、聯絡方式)
    # 分頁載入優化 (每頁20筆)
    # 返回總數與分頁資訊
```

#### 5.2 統計分析儀表板
**統計維度**：
- 總名片數量
- 健康度分布 (正常/問題名片比例)
- 缺失欄位統計
- 匯入來源分析
- 時間趨勢分析

**視覺化元件**：
- 圓餅圖: 健康度分布
- 長條圖: 缺失欄位排行
- 趨勢圖: 月度增長趨勢
- 數值卡片: 關鍵指標

### 6. 批量處理流程

#### 6.1 圖片批量匯入
**處理流程**：
1. **資料夾掃描**: 自動識別圖片檔案 (JPG/PNG)
2. **批次處理**: 
   - 記憶體使用監控 (85%閾值)
   - 智能批次大小調節
   - 並行處理優化
3. **OCR批量識別**: 
   - 失敗重試機制
   - 進度即時追蹤
   - 結果品質檢查
4. **資料庫批量寫入**:
   - 事務處理確保一致性
   - 重複資料檢測
   - 錯誤處理與回滾

**技術實現**：
```python
# 批量處理服務 (ocr_service.py)
class OCRService:
    async def process_batch_images(self, folder_path: str):
        # 記憶體監控 (psutil庫)
        # 85%閾值自動調節批次大小
        # 支援JPG/PNG格式
        # 垃圾回收與臨時檔案清理
        # 處理進度即時回報
```

#### 6.2 文本批量匯入
**支援格式與流程**：
- **Excel檔案** (.xlsx, .xls): 使用 openpyxl 解析
- **CSV檔案**: UTF-8編碼支援中文
- **檔案大小限制**: 最大50MB

**智能匹配流程**：
1. **欄位識別**: 自動識別中英文欄位名稱
2. **欄位映射**: 建立標準欄位對應關係
3. **資料驗證**: 格式檢查與必填欄位驗證
4. **重複檢測**: 基於姓名+公司+手機的複合鍵檢查
5. **批量寫入**: 50筆為一批次的資料庫寫入

**錯誤處理**：
- 詳細的錯誤報告
- 失敗記錄標注
- 部分成功處理
- 匯入統計報告

### 7. 資料匯出功能

#### 7.1 多格式匯出支援
**CSV格式**:
```python
def export_csv(cards):
    # UTF-8-SIG編碼 (支援Excel中文顯示)
    # 標準欄位對應
    # 自動檔案名稱生成
```

**Excel格式**:
```python  
def export_excel(cards):
    # 使用openpyxl生成
    # 自動調整欄寬
    # 格式化輸出
    # 中文字型支援
```

**vCard格式**:
```python
def export_vcard(cards):
    # 標準vCard 3.0格式
    # 支援行動裝置匯入
    # 多筆名片合併檔案
```

#### 7.2 匯出選項
- **單筆匯出**: 名片詳情頁面直接匯出
- **批量匯出**: 選擇多筆名片匯出
- **全部匯出**: 匯出所有名片資料
- **篩選匯出**: 基於搜尋條件的匯出

---

## 狀態管理與生命週期

### 應用狀態圖
```mermaid
stateDiagram-v2
    [*] --> 應用載入
    應用載入 --> 首頁: 初始化完成
    
    首頁 --> 掃描上傳: 選擇掃描
    首頁 --> 名片管理: 選擇管理
    
    掃描上傳 --> 相機模式: 選擇相機
    掃描上傳 --> 上傳模式: 選擇上傳
    
    相機模式 --> 權限檢查: 初始化相機
    權限檢查 --> 相機介面: 權限已授予
    權限檢查 --> 權限請求: 權限未授予
    權限請求 --> 相機介面: 用戶授權
    
    相機介面 --> 圖像處理: 拍攝完成
    上傳模式 --> 圖像處理: 上傳完成
    
    圖像處理 --> OCR識別: 增強完成
    OCR識別 --> 欄位解析: 識別完成
    欄位解析 --> 編輯確認: 解析完成
    
    編輯確認 --> 資料儲存: 用戶確認
    資料儲存 --> 名片管理: 儲存成功
    
    名片管理 --> 名片詳情: 查看名片
    名片管理 --> 搜尋結果: 搜尋操作
    名片管理 --> 批量處理: 批量操作
    名片管理 --> 匯出下載: 匯出操作
    
    批量處理 --> 圖片批量: 選擇圖片批量
    批量處理 --> 文本批量: 選擇文本批量
    
    圖片批量 --> 批量OCR: 開始處理
    文本批量 --> 欄位映射: 檔案解析
    
    批量OCR --> 批量儲存: OCR完成
    欄位映射 --> 批量儲存: 映射完成
    批量儲存 --> 名片管理: 處理完成
    
    名片詳情 --> 名片管理: 返回列表
    搜尋結果 --> 名片管理: 清除搜尋
    匯出下載 --> 名片管理: 匯出完成
```

### 錯誤處理流程
```mermaid
flowchart TD
    A[操作執行] --> B{是否成功}
    B -->|成功| C[正常流程繼續]
    B -->|失敗| D[錯誤類型判斷]
    
    D --> E{網路錯誤}
    D --> F{權限錯誤}
    D --> G{資料錯誤}
    D --> H{系統錯誤}
    
    E -->|是| I[顯示網路錯誤提示]
    F -->|是| J[顯示權限請求]
    G -->|是| K[顯示資料格式提示]
    H -->|是| L[顯示系統錯誤提示]
    
    I --> M[提供重試選項]
    J --> N[引導權限設定]
    K --> O[提供格式說明]
    L --> P[聯絡技術支援]
    
    M --> Q{用戶選擇}
    N --> Q
    O --> Q
    P --> Q
    
    Q -->|重試| A
    Q -->|取消| R[返回上一步]
```

---

## 效能最佳化策略

### 前端最佳化
1. **懶載入 (Lazy Loading)**: 路由組件按需載入
2. **圖片最佳化**: 縮圖預覽、漸進式載入
3. **分頁策略**: InfiniteScroll無限滾動，每頁20筆
4. **狀態管理**: React Hooks與本地狀態管理

### 後端最佳化
1. **資料庫最佳化**: SQLAlchemy ORM查詢優化
2. **記憶體管理**: psutil監控，85%閾值保護
3. **異步處理**: FastAPI async/await非阻塞
4. **檔案處理**: 臨時檔案自動清理

### OCR最佳化
1. **圖像預處理**: OpenCV 3倍放大增強
2. **批次最佳化**: 動態批次大小，記憶體控制
3. **容錯機制**: 3次重試，備用OCR API
4. **JSON直傳**: 結構化提示詞減少解析步驟

---

## 監控與維護

### 系統監控指標
- **效能指標**: OCR處理時間(<10秒)、API響應時間(<500ms)
- **資源使用**: 記憶體使用率(85%閾值)、CPU使用率
- **業務指標**: 名片處理量、正常/問題名片比例
- **錯誤追蹤**: OCR失敗率、重試次數、超時統計

### 維護策略
- **健康檢查**: `/health` 端點監控服務狀態
- **配置管理**: `.env` 環境變數集中管理
- **日誌管理**: FastAPI LoggingMiddleware記錄請求
- **臨時檔案**: 自動清理機制避免磁碟累積

---

## 總結

本應用流程文檔(v3.0)詳細描述了名片OCR管理系統的完整業務流程和技術實現。系統主要特點：

- **智能OCR識別**: OpenAI Vision API直接返回結構化JSON，減少解析步驟
- **圖像增強處理**: OpenCV 3倍放大與自動裁剪，提升識別準確率
- **健康度檢查**: 四維度檢查確保名片資料完整性
- **記憶體管理**: 85%閾值動態調節，防止系統過載
- **前後端分離**: React(1002端口) + FastAPI(8006端口)架構

系統已成功實現從名片掃描、OCR識別、資料編輯到批量處理的完整流程，為商務人士提供高效的名片數位化解決方案。