# 名片OCR管理系統 產品需求文檔 (PRD) · 2024 Q4

## 產品概要
- **目的**：將紙本名片以高正確率數位化，並集中管理、分類與匯出，支援營運人員快速檢索與分析。
- **使用者角色**
  - 業務／營運人員：上傳名片、校驗欄位、查詢與匯出。
  - 數據管理員：批次匯入、檢查資料品質、維護產業分類。
  - 系統維運：調整 OCR/OAI 連線、更新環境設定。
- **平台範圍**：Web。前端 React (port 1002)，後端 FastAPI (port 8006)，資料庫預設 SQLite（可替換）。

## 成功指標
- 單張名片從上傳到完成校驗 ≤ 90 秒。
- OCR 25 欄位自動填入覆蓋率 ≥ 80%，人工修正後資料完整率達 100%。
- 名片列表與搜尋每次回應時間 ≤ 500ms（1k 筆資料下）。
- 產業分類成功率 ≥ 95%，並可在 1 分鐘內完成 100 張名片批量分類。

## 核心模組與需求

### 1. 名片擷取與 OCR
| 功能 | 詳細說明 | 驗收標準 |
| --- | --- | --- |
| 圖像擷取 | `ScanUploadPage` 支援相機與檔案選擇，限制 JPG/PNG/≤10 MB，提供預覽 | 錯誤格式顯示提示；成功上傳即顯示縮圖 |
| 圖像增強 | `CardEnhancementService` 自動裁切、拉直、放大；失敗時回退到原圖 | 增強失敗不影響 OCR；日誌記錄處理路徑 |
| OCR 辨識 | `OCRService` 透過 `LLMApi` 呼叫本地或 OpenAI 相容 API，回傳結構化 JSON | API 必須回傳 25 個欄位（空值允許），失敗時回退訊息可提示重試 |

### 2. 欄位解析與資料驗證
| 功能 | 詳細說明 | 驗收標準 |
| --- | --- | --- |
| 智能欄位映射 | `parse-fields` 端點自動偵測 JSON 或純文字，處理中英文互換、電話、Email、Line ID 抽取 | 回傳結構必須包含 25 欄，欄位名稱固定；前端自動填寫 |
| 表單校驗 | `ScanUploadPage` 依 `checkCardStatus` 條件提醒缺漏 (姓名、公司、職位/部門、聯絡方式) | 提交缺漏資料時阻擋並提示；允許儲存空值但標記為「問題名片」 |
| 重複檢測 | 匯入流程以「姓名 + 公司 + 手機」為 Key 過濾重複 | 重複紀錄須跳過且提供統計 |

### 3. 名片管理
| 功能 | 詳細說明 | 驗收標準 |
| --- | --- | --- |
| 列表與搜尋 | `/api/v1/cards` 支援分頁、姓名/公司/職稱/聯絡方式模糊搜尋，前端顯示健康狀態標籤 | 預設每頁 100 筆，可透過 `skip/limit` 控制；搜尋結果正確 |
| 詳情檢視 | `CardDetailPage.js` 顯示完整欄位與上傳圖片連結 | 點擊名片可展開細節，圖片可載入 |
| 統計儀表板 | `/api/v1/cards/stats` 回傳總數、問題名片數、產業統計 | 與前端圖表資料一致，統計不受列表篩選影響 |

### 4. 產業分類與任務管理
| 功能 | 詳細說明 | 驗收標準 |
| --- | --- | --- |
| 單筆分類 | `IndustryClassificationService` 以公司、職稱建立 Prompt，OpenAI Chat 回傳產業、信心度 | 需支援 5 類（防詐/旅宿/工業應用/食品業/其他），失敗時設為「其他」並信心度 0 |
| 批量分類 | `/cards/classify/batch` 使用背景執行緒和 `task_manager` 追蹤狀態 | 任務建立後立即回傳 Task ID，完成/失敗皆更新狀態與錯誤訊息 |
| 任務監控 | `/tasks/{id}`、`/tasks/{id}/cancel` 查詢或取消任務 | 任務資訊包含進度、成功/失敗數、錯誤說明；取消後需釋放資源 |

### 5. 匯出與批量操作
| 功能 | 詳細說明 | 驗收標準 |
| --- | --- | --- |
| 資料匯出 | `export` 支援 CSV、Excel、vCard；Excel 以 `openpyxl` 生成，CSV/vCard 以串流輸出 | 檔名含日期時間；欄位順序與 `CardResponse` 一致；UTF-8 |
| 批量匯入 | `/batch-import` 讀取 `ocr_card_background/uploads/`，呼叫增強與 OCR，並寫入資料庫 | 成功/失敗筆數需回報；遇到重複或缺失欄位時加入備註說明 |
| 文本匯入 | `text_import_service` 支援 CSV/Excel 解析與欄位映射 | 自動偵測欄位標題，缺漏欄位要記錄問題清單 |

## 非功能需求
- **效能**：批量任務必須監控記憶體使用 (`BatchProcessingService`)，超過閾值時暫停並釋放資源。
- **可靠性**：OCR/OAI 呼叫需具備重試與錯誤回傳；臨時檔案與增強副本必須在流程結束後移除。
- **安全性**：所有 API 僅供內網使用；`output/` 與 `uploads/` 保持 `.gitignore`；敏感欄位（手機、Email）僅在授權頁面顯示。
- **可維運性**：日誌需指出請求 ID、檔案名稱與錯誤原因；`settings.print_settings_summary()` 在啟動時列出關鍵設定。

## 環境與設定
- `.env` 需提供 `OCR_API_URL`、`OCR_API_KEY`、`OPENAI_API_KEY`、`OPENAI_BASE_URL` 等；若缺失，`check_environment()` 要給出警示。
- `USE_CARD_ENHANCEMENT`、`USE_OPENCV`、`BATCH_PROCESSING_SIZE` 可調整影像處理策略。
- Docker 執行時透過 `docker-compose.yml` 將 `DATABASE_URL` 指向 volume `data/cards.db`。

## 開發與發佈節奏
1. **M1 · OCR 基礎**：完成上傳、OCR、欄位解析與單筆名片保存。
2. **M2 · 管理能力**：實作列表、搜尋、統計、匯出，補齊資料驗證。
3. **M3 · 智能增強**：導入產業分類、批量處理、記憶體監控與任務追蹤。
4. **M4 · 維運與優化**：調整 UI/UX、完善錯誤回報、增加測試與部署腳本。

> 后續需求（如多租戶、權限管理）須與業務端確認後再行規劃。
